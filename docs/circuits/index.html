<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-v1.x docs-doc-page docs-doc-id-circuits" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.1.1">
<title data-rh="true">MACI Circuits | MACI</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://maci.pse.dev/img/maci-card.png"><meta data-rh="true" name="twitter:image" content="https://maci.pse.dev/img/maci-card.png"><meta data-rh="true" property="og:url" content="https://maci.pse.dev/docs/circuits"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="v1.x"><meta data-rh="true" name="docusaurus_tag" content="docs-default-v1.x"><meta data-rh="true" name="docsearch:version" content="v1.x"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-v1.x"><meta data-rh="true" property="og:title" content="MACI Circuits | MACI"><meta data-rh="true" name="description" content="Introduction to the core zk-SNARK circuits of MACI"><meta data-rh="true" property="og:description" content="Introduction to the core zk-SNARK circuits of MACI"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://maci.pse.dev/docs/circuits"><link data-rh="true" rel="alternate" href="https://maci.pse.dev/docs/circuits" hreflang="en"><link data-rh="true" rel="alternate" href="https://maci.pse.dev/docs/circuits" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="MACI RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="MACI Atom Feed">





<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.3efc238b.css">
<script src="/assets/js/runtime~main.58602575.js" defer="defer"></script>
<script src="/assets/js/main.4388e5a6.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_ML3d" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">MACI</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Documentation</a><a class="navbar__item navbar__link" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/roadmap">Roadmap</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/docs/introduction">v1.x</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/circuits">v1.x</a></li><li><a class="dropdown__link" href="/docs/v0.x/circuits">v0.x</a></li></ul></div><div class="navbarSearchContainer_qEKT"><div class="navbar__search searchBarContainer_NuUV"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_B52I searchBarLoadingRing_of1z"><div></div><div></div><div></div><div></div></div></div></div><a href="https://github.com/privacy-scaling-explorations/maci" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_zI7a"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_a2Ef colorModeToggle_J33C"><button class="clean-btn toggleButton_K7OJ toggleButtonDisabled_JIWS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_X1z7"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wOoS"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_aR1s"><div class="docsWrapper_d1tO"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_CI3s" type="button"></button><div class="docRoot_Ec1W"><aside class="theme-doc-sidebar-container docSidebarContainer_Cazd"><div class="sidebarViewport_XsVM"><div class="sidebar_Iuzv"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_tEnT"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/purpose">Purpose</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/workflow">Workflow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/installation">Installation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/primitives">Primitives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/cli">Command-line interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/contracts">Smart Contracts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/docs/circuits">Circuits</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/trusted-setup">Trusted Setup</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/testing">Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/testing-in-detail">Testing in detail</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/integrating">Integrating</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/audit">Security audits</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/ci-pipeline">CI</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/coordinator-processing">Coordinator local processing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/spec">Specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/key-change">Key change</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/troubleshooting">Troubleshooting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/versioning">MACI versioning</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/contributing/">Contributing</a><button aria-label="Expand sidebar category &#x27;Contributing&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/topup">Topup</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/solidity-docs/">Solidity Docs</a><button aria-label="Expand sidebar category &#x27;Solidity Docs&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/typedoc/">Typedoc</a><button aria-label="Expand sidebar category &#x27;Typedoc&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_Aw6Y"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_mQIU"><div class="docItemContainer_IWC5"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_S2jZ" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_E5cy"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Circuits</span><meta itemprop="position" content="1"></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: v1.x</span><div class="tocCollapsible_IFRJ theme-doc-toc-mobile tocMobile_l9eB"><button type="button" class="clean-btn tocCollapsibleButton_swoQ">On this page</button></div><div class="theme-doc-markdown markdown"><h1>zk-SNARKS in MACI</h1>
<p>MACI uses zk-SNARKs to essentially hide how each person voted while still revealing the final vote result. This gives voters privacy and helps reduce bribery while still ensuring that the final results were tallied correctly off-chain.</p>
<h2 class="anchor anchorWithStickyNavbar_I2WF" id="maci-circuits">MACI Circuits<a href="#maci-circuits" class="hash-link" aria-label="Direct link to MACI Circuits" title="Direct link to MACI Circuits">​</a></h2>
<p>MACI has three main zk-SNARK <a href="https://github.com/privacy-scaling-explorations/maci/tree/dev/circuits" target="_blank" rel="noopener noreferrer">circuits</a>:</p>
<ol>
<li><a href="https://github.com/privacy-scaling-explorations/maci/blob/dev/circuits/circom/processMessages.circom" target="_blank" rel="noopener noreferrer"><code>ProcessMessages.circom</code></a>, which takes a batch of encrypted messages, decrypts them, and generates a proof that the coordinator&#x27;s local processing was performed correctly.</li>
<li><a href="https://github.com/privacy-scaling-explorations/maci/blob/dev/circuits/circom/tallyVotes.circom" target="_blank" rel="noopener noreferrer"><code>TallyVotes.circom</code></a>, which counts votes from users&#x27; ballots, batch by batch.</li>
<li><a href="https://github.com/privacy-scaling-explorations/maci/blob/dev/circuits/circom/subsidy.circom" target="_blank" rel="noopener noreferrer"><code>Subsidy.circom</code></a>, which implements <a href="https://hackmd.io/@chaosma/H1_9xmT2K" target="_blank" rel="noopener noreferrer">pairwise subsidy</a>. Please note this is an optional feature.</li>
</ol>
<p>The rest of the circuits are utilities templates that are required for the main circuits to work correctly. These include utilities such as float math, conversion of private keys, and Poseidon hashing/encryption.</p>
<p>Each circuit is parameterised and it is important to set the right parameters that matches your use case. For example, if you want to support up to 3125 messages, the message tree depth parameter should be set to <code>5</code> (as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>5</mn><mn>5</mn></msup><mo>=</mo><mn>3125</mn></mrow><annotation encoding="application/x-tex">5^5 = 3125</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">3125</span></span></span></span>).</p>
<h2 class="anchor anchorWithStickyNavbar_I2WF" id="background">Background<a href="#background" class="hash-link" aria-label="Direct link to Background" title="Direct link to Background">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="zk-snarks">zk-SNARKs<a href="#zk-snarks" class="hash-link" aria-label="Direct link to zk-SNARKs" title="Direct link to zk-SNARKs">​</a></h3>
<p>zk-SNARKs are a type of zero-knowledge proof which allows a &quot;prover&quot; to prove to a &quot;verifier&quot; that they know a secret without revealing the secret itself. In MACI, the prover is the coordinator. MACI uses zk-SNARKs to prove that the coordinator has correctly processed the batches of messages and that all votes have been tallied correctly. A smart contract acts as the verifier to check the proof from the coordinator. Users can also verify that the process was done correctly at any point after the proof generation.</p>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="circom">Circom<a href="#circom" class="hash-link" aria-label="Direct link to Circom" title="Direct link to Circom">​</a></h3>
<p>MACI&#x27;s circuits are written using <a href="https://docs.circom.io/" target="_blank" rel="noopener noreferrer">Circom</a>, a domain-specific language (DSL) used to write zk-SNARK circuits. Circom syntax resembles JavaScript, and it currently is one of the most popular DSL in use by zk developers. Please refer to their documentation to learn more about the language.</p>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="proving-system">Proving system<a href="#proving-system" class="hash-link" aria-label="Direct link to Proving system" title="Direct link to Proving system">​</a></h3>
<p>MACI uses <a href="https://eprint.iacr.org/2016/260.pdf" target="_blank" rel="noopener noreferrer">Groth16</a> as its proving system. Groth16 is a zk-SNARK proving system that allows for the generation of proofs that are small and fast to verify.</p>
<h2 class="anchor anchorWithStickyNavbar_I2WF" id="how-are-the-circuits-used">How are the circuits used?<a href="#how-are-the-circuits-used" class="hash-link" aria-label="Direct link to How are the circuits used?" title="Direct link to How are the circuits used?">​</a></h2>
<p>The circuits are used by the coordinator (the prover) to prove that they have correctly processed a batch of messages and tallied the votes correctly. This happens after a Poll has completed, and the coordinator has merged the state and message trees. The coordinator then generates a proof for each batch of messages, and submits them to the contract. The contract then verifies the proofs and updates the commitments on chain.</p>
<h2 class="anchor anchorWithStickyNavbar_I2WF" id="how-do-the-circuits-fit-in-a-voting-round">How do the Circuits fit in a voting round?<a href="#how-do-the-circuits-fit-in-a-voting-round" class="hash-link" aria-label="Direct link to How do the Circuits fit in a voting round?" title="Direct link to How do the Circuits fit in a voting round?">​</a></h2>
<p><img decoding="async" loading="lazy" alt="flow" src="/assets/images/processingAfterPollEnds-f295ffdbdfab2524514fd24572bf24e6.svg" width="8516" height="4875" class="img_aEan"></p>
<h2 class="anchor anchorWithStickyNavbar_I2WF" id="how-do-the-circuits-work">How do the circuits work?<a href="#how-do-the-circuits-work" class="hash-link" aria-label="Direct link to How do the circuits work?" title="Direct link to How do the circuits work?">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="message-processing-processmessages">Message processing (<a href="https://github.com/privacy-scaling-explorations/maci/blob/dev/circuits/circom/processMessages.circom" target="_blank" rel="noopener noreferrer"><code>processMessages</code></a>)<a href="#message-processing-processmessages" class="hash-link" aria-label="Direct link to message-processing-processmessages" title="Direct link to message-processing-processmessages">​</a></h3>
<p>This circuit allows the coordinator to prove that they have correctly processed each message in reverse order, in a consecutive batch of 5 ^ msgBatchDepth messages to the respective state leaf within the state tree. Coordinators would use this circuit to prove correct execution at the end of each Poll.</p>
<p>The <code>processMessages</code> circuit will try to decrypt the messages, and based on the content of the message, update within itself the trees, to generate a proof that the coordinator&#x27;s off-chain processing was done correctly. In other words, the circuit takes a final state, an initial state, and the leaves (messages and user signups) - it process these messages via the different state transitions to finally check that the expected state is correct.
The pre-requisites for this circuit are:</p>
<ul>
<li>the related Poll has ended</li>
<li>the state tree has been merged</li>
<li>the message tree has been merged</li>
</ul>
<p>This circuit requires the coordinator&#x27;s private key, hence a proof for this circuit can only be generated by the coordinator. The private key is needed in order to generate the ECDH shared key used to decrypt the messages.</p>
<p><img decoding="async" loading="lazy" alt="ProcessMessages" src="/assets/images/processMessages-8eae9355f7f4efa50ca9a10fb084bd7a.svg" width="4568" height="4075" class="img_aEan"></p>
<div class="theme-admonition theme-admonition-info admonition_cYif alert alert--info"><div class="admonitionHeading_fPDr"><span class="admonitionIcon_d_zO"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_vEJX"><p>A version working with non quadratic voting (non-qv) is also available. This version is called <code>processMessagesNonQV</code> and is to be used when the Poll is not using the quadratic voting feature. Note that by default MACI works with quadratic voting.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="parameters">Parameters<a href="#parameters" class="hash-link" aria-label="Direct link to Parameters" title="Direct link to Parameters">​</a></h4>
<table><thead><tr><th>#</th><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>0</td><td>State tree depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> signups.</td></tr><tr><td>1</td><td>Message tree depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> votes or key-change messages.</td></tr><tr><td>2</td><td>Message batch tree depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> messages to be processed per batch.</td></tr><tr><td>3</td><td>Vote option tree depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> vote options.</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="inputs">Inputs<a href="#inputs" class="hash-link" aria-label="Direct link to Inputs" title="Direct link to Inputs">​</a></h4>
<table><thead><tr><th>Input signal</th><th>Description</th></tr></thead><tbody><tr><td><code>inputHash</code></td><td>The SHA256 hash of inputs supplied by the contract</td></tr><tr><td><code>packedVals</code></td><td>Described below</td></tr><tr><td><code>pollEndTimestamp</code></td><td>The Unix timestamp at which the poll ends</td></tr><tr><td><code>msgRoot</code></td><td>The root of the message tree</td></tr><tr><td><code>msgs</code></td><td>The batch of messages as an array of arrays</td></tr><tr><td><code>msgSubrootPathElements</code></td><td>Described below</td></tr><tr><td><code>coordinatorPubKeyHash</code></td><td><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>i</mi><mi>d</mi><mi>o</mi><msub><mi>n</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><mi>c</mi><mi>P</mi><msub><mi>k</mi><mi>x</mi></msub><mo separator="true">,</mo><mi>c</mi><mi>P</mi><msub><mi>k</mi><mi>y</mi></msub><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">poseidon_2([cPk_x, cPk_y])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ose</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">c</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">])</span></span></span></span></td></tr><tr><td><code>newSbCommitment</code></td><td>Described below</td></tr><tr><td><code>coordPrivKey</code></td><td>The coordinator&#x27;s private key</td></tr><tr><td><code>coordPubKey</code></td><td>The coordinator&#x27;s public key</td></tr><tr><td><code>encPubKeys</code></td><td>The public keys used to generate shared ECDH encryption keys to encrypt the messages</td></tr><tr><td><code>currentStateRoot</code></td><td>The state root before the commands are applied</td></tr><tr><td><code>currentStateLeaves</code></td><td>The state leaves upon which messages are applied</td></tr><tr><td><code>currentStateLeavesPathElements</code></td><td>The Merkle path to each incremental state root</td></tr><tr><td><code>currentSbCommitment</code></td><td>Described below</td></tr><tr><td><code>currentSbSalt</code></td><td>Described below</td></tr><tr><td><code>newSbCommitment</code></td><td>Described below</td></tr><tr><td><code>newSbSalt</code></td><td>Described below</td></tr><tr><td><code>currentBallotRoot</code></td><td>The root of the ballot tree before messages are applied</td></tr><tr><td><code>currentBallots</code></td><td>The ballots upon which ballots are applied</td></tr><tr><td><code>currentBallotsPathElements</code></td><td>The Merkle path to each incremental ballot root</td></tr><tr><td><code>currentVoteWeights</code></td><td>The existing vote weight for the vote option in the ballot which each command refers to</td></tr><tr><td><code>currentVoteWeightsPathElements</code></td><td>The Merkle path from each vote weight to the vote option root in its ballot</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="inputhash"><code>inputHash</code><a href="#inputhash" class="hash-link" aria-label="Direct link to inputhash" title="Direct link to inputhash">​</a></h5>
<p>All inputs to this circuit are private except for <code>inputHash</code>. To save gas during verification, the <code>MessageProcessor</code> contract hashes the following values using SHA256 and uses the hash as the sole element of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>c</mi></mrow><annotation encoding="application/x-tex">ic</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span></span></span></span>:</p>
<ol>
<li><code>packedVals</code></li>
<li><code>coordinatorPubKeyHash</code></li>
<li><code>msgRoot</code></li>
<li><code>currentSbCommitment</code></li>
<li><code>newSbCommitment</code></li>
<li><code>pollEndTimestamp</code></li>
</ol>
<p>The hash is computed using the <code>sha256</code> Solidity function and is then subject to modulo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>.</p>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="packedvals"><code>packedVals</code><a href="#packedvals" class="hash-link" aria-label="Direct link to packedvals" title="Direct link to packedvals">​</a></h5>
<p><code>packedVals</code> is the following values represented as one field element. Consider that a field element is roughly 253 bits. The big-endian bit-representation is as such:</p>
<table><thead><tr><th>Bits</th><th>Value</th></tr></thead><tbody><tr><td>1st 53 bits</td><td><code>0</code></td></tr><tr><td>2nd 50 bits</td><td><code>batchEndIndex</code></td></tr><tr><td>3rd 50 bits</td><td><code>currentMessageBatchIndex</code></td></tr><tr><td>4th 50 bits</td><td><code>numSignUps</code></td></tr><tr><td>5th 50 bits</td><td><code>maxVoteOptions</code></td></tr></tbody></table>
<p>For instance, if <code>maxVoteOptions</code> is 25 and <code>batchEndIndex</code> is <code>5</code>, and all other values are 0, the following is the <code>packedVals</code> representation in hexadecimal:</p>
<p><code>140000000000000000000000000000000000019</code></p>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="currentsbcommitment-and-newsbcommitment"><code>currentSbCommitment</code> and <code>newSbCommitment</code><a href="#currentsbcommitment-and-newsbcommitment" class="hash-link" aria-label="Direct link to currentsbcommitment-and-newsbcommitment" title="Direct link to currentsbcommitment-and-newsbcommitment">​</a></h5>
<p>The <code>currentSbCommitment</code> is the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>i</mi><mi>d</mi><mi>o</mi><msub><mi>n</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">poseidon_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ose</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> hash of the state tree root, the ballot tree root, and a random salt. The purpose of the random salt, which should be unique to each batch, is to ensure that the value of <code>currentSbCommitment</code> always changes even if all the commands in a batch are invalid and therefore do not change the state tree or ballot tree root.</p>
<p>The result of applying a batch of messages to <code>currentSbCommitment</code> is <code>newSbCommitment</code>.</p>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="currentsbsalt"><code>currentSbSalt</code><a href="#currentsbsalt" class="hash-link" aria-label="Direct link to currentsbsalt" title="Direct link to currentsbsalt">​</a></h5>
<p>The salt used to produce <code>currentSbCommitment</code> (see above).</p>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="newsbsalt"><code>newSbSalt</code><a href="#newsbsalt" class="hash-link" aria-label="Direct link to newsbsalt" title="Direct link to newsbsalt">​</a></h5>
<p>The salt used to produce <code>newSbCommitment</code> (see above).</p>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="msgsubrootpathelements"><code>msgSubrootPathElements</code><a href="#msgsubrootpathelements" class="hash-link" aria-label="Direct link to msgsubrootpathelements" title="Direct link to msgsubrootpathelements">​</a></h5>
<p>The index of each message in <code>msgs</code> is consecutive. As such, in order to prove that each message in <code>msgs</code> is indeed a leaf of the message tree, we compute the subtree root of <code>msgs</code>, and then verify that the subtree root is indeed a subroot of <code>msgRoot</code>.</p>
<p>A simplified example using a tree of arity 2:</p>
<div class="codeBlockContainer_fGGS theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_GhYr"><pre tabindex="0" class="prism-code language-text codeBlock_iyix thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_Zmwf"><span class="token-line" style="color:#bfc7d5"><span class="token plain">             r</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           /  \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          s    ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">       /    \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      o     o</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     / \   / \</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   a   b  c  d</span><br></span></code></pre><div class="buttonGroup_uUDv"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_X4PI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_C5XV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_TwkE"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>To prove that <code>a...d</code> are leaves of the tree with root <code>r</code>, we prove that the leaves have the subroot <code>s</code> with depth 2, and <em>then</em> prove that <code>s</code> is a member of <code>r</code> at depth 1.</p>
<p>The implementation for this is in the <code>QuinBatchLeavesExists</code> circuit in <code>https://github.com/privacy-scaling-explorations/maci/blob/dev/circuits/circom/trees/incrementalQuinTree.circom</code>.</p>
<p>This method requires fewer circuit constraints than if we verified a Merkle proof for each leaf.</p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="statements-that-the-circuit-proves">Statements that the circuit proves<a href="#statements-that-the-circuit-proves" class="hash-link" aria-label="Direct link to Statements that the circuit proves" title="Direct link to Statements that the circuit proves">​</a></h4>
<ol>
<li>That the prover knows the preimage to <code>inputHash</code> (see above)</li>
<li>That the prover knows the preimage to <code>currentSbCommitment</code> (that is, the state root, ballot root, and <code>currentSbSalt</code>)</li>
<li>That <code>maxVoteOptions &lt;= (5 ^ voteOptionTreeDepth)</code></li>
<li>That <code>numSignUps &lt;= (5 ^ stateTreeDepth)</code></li>
<li>That <code>coordPubKey</code> is correctly derived from <code>coordPrivKey</code></li>
<li>That <code>coordPubKey</code> is the preimage to the Poseidon hash of <code>coordPubKey</code> (provided by the contract)</li>
<li>That each message in <code>msgs</code> exists in the message tree</li>
<li>That after decrypting and applying each message, in reverse order, to the corresponding state and ballot leaves, the new state root, new ballot root, and <code>newSbSalt</code> are the preimage to <code>newSbCommitment</code></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="tally-votes-tallyvotes">Tally Votes (<a href="https://github.com/privacy-scaling-explorations/maci/blob/dev/circuits/circom/tallyVotes.circom" target="_blank" rel="noopener noreferrer"><code>tallyVotes</code></a>)<a href="#tally-votes-tallyvotes" class="hash-link" aria-label="Direct link to tally-votes-tallyvotes" title="Direct link to tally-votes-tallyvotes">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="parameters-1">Parameters<a href="#parameters-1" class="hash-link" aria-label="Direct link to Parameters" title="Direct link to Parameters">​</a></h4>
<table><thead><tr><th>#</th><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>0</td><td>State tree depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> signups.</td></tr><tr><td>1</td><td>State leaf batch depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> users&#x27; votes to be processed per batch.</td></tr><tr><td>2</td><td>Vote option tree depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> vote options.</td></tr></tbody></table>
<p><img decoding="async" loading="lazy" alt="TallyVotes" src="/assets/images/tallyVotes-98b78d32585a09323e1b1e96f83abd1b.svg" width="5131" height="3000" class="img_aEan"></p>
<div class="theme-admonition theme-admonition-info admonition_cYif alert alert--info"><div class="admonitionHeading_fPDr"><span class="admonitionIcon_d_zO"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_vEJX"><p>A version working with non quadratic voting (non-qv) is also available. This version is called <code>tallyVotesNonQv</code> and is to be used when the Poll is not using the quadratic voting feature. Note that by default MACI works with quadratic voting.</p></div></div>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="input-signals">Input signals<a href="#input-signals" class="hash-link" aria-label="Direct link to Input signals" title="Direct link to Input signals">​</a></h4>
<table><thead><tr><th>Input signal</th><th>Description</th></tr></thead><tbody><tr><td><code>inputHash</code></td><td>The SHA256 hash of inputs supplied by the contract</td></tr><tr><td><code>packedVals</code></td><td>Described below</td></tr><tr><td><code>sbCommitment</code></td><td>Described below</td></tr><tr><td><code>currentTallyCommitment</code></td><td>Described below</td></tr><tr><td><code>newTallyCommitment</code></td><td>Described below</td></tr><tr><td><code>stateRoot</code></td><td>The root of the state tree after all messages have been applied</td></tr><tr><td><code>ballotRoot</code></td><td>The root of the ballot tree after all messages have been applied</td></tr><tr><td><code>sbSalt</code></td><td>The salt used to produce <code>sbCommitment</code></td></tr><tr><td><code>ballots</code></td><td>The ballots in the batch being tallied</td></tr><tr><td><code>ballotPathElements</code></td><td>The Merkle path to each ballot leaf</td></tr><tr><td><code>votes</code></td><td>The votes in each ballot cast per result</td></tr><tr><td><code>currentResults</code></td><td>The current tally of votes per vote option</td></tr><tr><td><code>currentResultsRootSalt</code></td><td>A random value</td></tr><tr><td><code>currentSpentVoiceCreditSubtotal</code></td><td>The subtotal of voice credits spent across all vote options</td></tr><tr><td><code>currentSpentVoiceCreditSubtotalSalt</code></td><td>A random value</td></tr><tr><td><code>currentPerVOSpentVoiceCredits</code></td><td>The voice credits spent on each vote option so far</td></tr><tr><td><code>currentPerVOSpentVoiceCreditsRootSalt</code></td><td>A random value</td></tr><tr><td><code>newResultsRootSalt</code></td><td>A random value</td></tr><tr><td><code>newPerVOSpentVoiceCreditsRootSalt</code></td><td>A random value</td></tr><tr><td><code>newSpentVoiceCreditSubtotalSalt</code></td><td>A random value</td></tr></tbody></table>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="inputhash-1"><code>inputHash</code><a href="#inputhash-1" class="hash-link" aria-label="Direct link to inputhash-1" title="Direct link to inputhash-1">​</a></h5>
<p>All inputs to this circuit are private except for <code>inputHash</code>. To save gas during verification, the <code>Tally</code> contract hashes the following values using SHA256 and uses the hash as the sole element of <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mi>c</mi></mrow><annotation encoding="application/x-tex">ic</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em"></span><span class="mord mathnormal">i</span><span class="mord mathnormal">c</span></span></span></span>:</p>
<ol>
<li><code>packedVals</code></li>
<li><code>sbCommitment</code></li>
<li><code>currentTallyCommitment</code></li>
<li><code>newTallyCommitment</code></li>
</ol>
<p>The hash is computed using the <code>sha256</code> Solidity function and is then subject to modulo <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span>.</p>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="packedvals-1"><code>packedVals</code><a href="#packedvals-1" class="hash-link" aria-label="Direct link to packedvals-1" title="Direct link to packedvals-1">​</a></h5>
<p><code>packedVals</code> is the following values represented as one field element. Consider that a field element is roughly 253 bits. The big-endian bit-representation is as such:</p>
<table><thead><tr><th>Bits</th><th>Value</th></tr></thead><tbody><tr><td>1st 53 bits</td><td><code>0</code></td></tr><tr><td>2nd 50 bits</td><td><code>0</code></td></tr><tr><td>3rd 50 bits</td><td><code>0</code></td></tr><tr><td>4th 50 bits</td><td><code>numSignUps</code></td></tr><tr><td>5th 50 bits</td><td><code>batchStartIndex</code></td></tr></tbody></table>
<p><code>numSignUps</code>, a value provided by the contract, is the number of users who have signed up. This is one less than the number of leaves inserted in the state tree (since the 0th state leaf is a <a href="/docs/primitives#state-leaf">blank state leaf</a>). <code>batchStartIndex</code> is the ballot tree index at which the batch begins.</p>
<p>For instance, if <code>numSignUps</code> is 25 and the batch index is <code>5</code>, and all other values are 0, the following is the <code>packedVals</code> representation in hexadecimal:</p>
<p><code>64000000000005</code></p>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="sbcommitment"><code>sbCommitment</code><a href="#sbcommitment" class="hash-link" aria-label="Direct link to sbcommitment" title="Direct link to sbcommitment">​</a></h5>
<p>The commitment to <code>stateRoot</code>, <code>ballotRoot</code>, and <code>sbSalt</code>:</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>i</mi><mi>d</mi><mi>o</mi><msub><mi>n</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mi>R</mi><mi>o</mi><mi>o</mi><mi>t</mi><mo separator="true">,</mo><mi>b</mi><mi>a</mi><mi>l</mi><mi>l</mi><mi>o</mi><mi>t</mi><mi>R</mi><mi>o</mi><mi>o</mi><mi>t</mi><mo separator="true">,</mo><mi>s</mi><mi>b</mi><mi>S</mi><mi>a</mi><mi>l</mi><mi>t</mi><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">poseidon_3([stateRoot, ballotRoot, sbSalt])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ose</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">ba</span><span class="mord mathnormal" style="margin-right:0.01968em">ll</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.00773em">tR</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">t</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.05764em">S</span><span class="mord mathnormal">a</span><span class="mord mathnormal">lt</span><span class="mclose">])</span></span></span></span></p>
<p>Proving preimage of <code>sbCommitment</code> is one out of the several steps required to prove that the votes were tallied correctly. By establishing that the coordinator knows <code>ballotRoot</code>, the coordinator can (using other parts of the circuit) prove that they know the preimage of the ballot leaves in the batch being tallied.</p>
<h5 class="anchor anchorWithStickyNavbar_I2WF" id="currenttallycommitment-and-newtallycommitment"><code>currentTallyCommitment</code> and <code>newTallyCommitment</code><a href="#currenttallycommitment-and-newtallycommitment" class="hash-link" aria-label="Direct link to currenttallycommitment-and-newtallycommitment" title="Direct link to currenttallycommitment-and-newtallycommitment">​</a></h5>
<p>A tally is represented by a <em>tally commitment</em>, which is the <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>i</mi><mi>d</mi><mi>o</mi><msub><mi>n</mi><mn>3</mn></msub></mrow><annotation encoding="application/x-tex">poseidon_3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ose</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> hash of:</p>
<ol>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><msub><mi>c</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">tc_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>: a commitment to the votes per option<!-- -->
<ul>
<li>This is the hash of the Merkle root <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">r_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> of the votes and a salt <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>r</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">r_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, computed as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>i</mi><mi>d</mi><mi>o</mi><msub><mi>n</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><msub><mi>r</mi><mi>r</mi></msub><mo separator="true">,</mo><msub><mi>r</mi><mi>s</mi></msub><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">poseidon_2([r_r, r_s])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ose</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">])</span></span></span></span></li>
</ul>
</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><msub><mi>c</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">tc_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>: a commitment to the total spent voice credits<!-- -->
<ul>
<li>This is the hash of the total spent voice credits <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">t_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> and a salt <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>t</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">t_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7651em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, computed as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>i</mi><mi>d</mi><mi>o</mi><msub><mi>n</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><msub><mi>t</mi><mi>c</mi></msub><mo separator="true">,</mo><msub><mi>t</mi><mi>s</mi></msub><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">poseidon_2([t_c, t_s])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ose</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">])</span></span></span></span></li>
</ul>
</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><msub><mi>c</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">tc_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9012em;vertical-align:-0.2861em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span>: a commitment to the spent voice credits per vote option<!-- -->
<ul>
<li>This is the hash of the Merkle root of the spent voice credits per vote option <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">p_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> and a salt <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">p_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>, computed as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>i</mi><mi>d</mi><mi>o</mi><msub><mi>n</mi><mn>2</mn></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><msub><mi>p</mi><mi>v</mi></msub><mo separator="true">,</mo><msub><mi>p</mi><mi>s</mi></msub><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">poseidon_2([p_v, p_s])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ose</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">])</span></span></span></span></li>
</ul>
</li>
</ol>
<p>The tally commitment is computed as such:</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi><mi>o</mi><mi>s</mi><mi>e</mi><mi>i</mi><mi>d</mi><mi>o</mi><msub><mi>n</mi><mn>3</mn></msub><mo stretchy="false">(</mo><mo stretchy="false">[</mo><mi>t</mi><msub><mi>c</mi><mi>r</mi></msub><mo separator="true">,</mo><mi>t</mi><msub><mi>c</mi><mi>t</mi></msub><mo separator="true">,</mo><mi>t</mi><msub><mi>c</mi><mi>p</mi></msub><mo stretchy="false">]</mo><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">poseidon_3([tc_r, tc_t, tc_p])</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">ose</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">([</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mclose">])</span></span></span></span></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="statements-that-the-circuit-proves-1">Statements that the circuit proves<a href="#statements-that-the-circuit-proves-1" class="hash-link" aria-label="Direct link to Statements that the circuit proves" title="Direct link to Statements that the circuit proves">​</a></h4>
<ol>
<li>That the coordinator knows the preimage of <code>sbCommitment</code></li>
<li>That the coordinator knows the preimage of <code>inputHash</code></li>
<li>That <code>batchStartIndex</code> is less than or equal to <code>numSignUps</code></li>
<li>That each ballot in <code>ballots</code> is in a member of the ballot tree with the Merkle root <code>ballotRoot</code> at indices <code>batchStartIndex</code> to <code>batchStartIndex + (5 ** intStateTreeDepth)</code></li>
<li>That each set of votes (<code>votes[i]</code>) has the Merkle root <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mi>l</mi><msub><mi>t</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">blt_r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em"></span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> whose value equals <code>ballots[i][1]</code></li>
<li>That the tally is valid, which is:<!-- -->
<ul>
<li>That the sum of votes per vote option is correct</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="subsisdy-subsidy">Subsisdy (<a href="https://github.com/privacy-scaling-explorations/maci/blob/dev/circuits/circom/subsidy.circom" target="_blank" rel="noopener noreferrer"><code>subsidy</code></a>)<a href="#subsisdy-subsidy" class="hash-link" aria-label="Direct link to subsisdy-subsidy" title="Direct link to subsisdy-subsidy">​</a></h3>
<p>This circuit is an optional feature - it&#x27;s not required for MACI to function.<br>
<!-- -->The subsidy circuit is used to implement pairwise subsidy. This is a technique that can be used to detect voters collusion. It currently is not optimized for production and the team will work on a more efficient implementation in the future.</p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="parameters-2">Parameters<a href="#parameters-2" class="hash-link" aria-label="Direct link to Parameters" title="Direct link to Parameters">​</a></h4>
<table><thead><tr><th>#</th><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>0</td><td>State tree depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> signups.</td></tr><tr><td>1</td><td>State leaf batch depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> users&#x27; votes to be processed per batch.</td></tr><tr><td>2</td><td>Vote option tree depth</td><td>Allows <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><msup><mn>5</mn><mi>n</mi></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">(5^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.6644em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> vote options.</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="utility-circuits">Utility circuits<a href="#utility-circuits" class="hash-link" aria-label="Direct link to Utility circuits" title="Direct link to Utility circuits">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="process-messages-input-hasher">Process Messages Input Hasher<a href="#process-messages-input-hasher" class="hash-link" aria-label="Direct link to Process Messages Input Hasher" title="Direct link to Process Messages Input Hasher">​</a></h4>
<p>An utility circuit used by the main <code>processMessages</code> circuit to hash its inputs.</p>
<p><img decoding="async" loading="lazy" alt="ProcessMessagesInputHasher" src="/assets/images/processMessagesInputHasher-a054ca4bf7b46ce1c4a2cdff1e3a655d.svg" width="3146" height="1482" class="img_aEan"></p>
<p>It outputs one field element, which is the SHA256 hash of the following inputs:</p>
<ol>
<li><code>packedVals</code></li>
<li><code>pollEndTimestamp</code></li>
<li><code>msgRoot</code></li>
<li><code>coordinatorPubKeyHash</code></li>
<li><code>newSbCommitment</code></li>
<li><code>currentSbCommitment</code></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="tally-votes-input-hasher">Tally Votes Input Hasher<a href="#tally-votes-input-hasher" class="hash-link" aria-label="Direct link to Tally Votes Input Hasher" title="Direct link to Tally Votes Input Hasher">​</a></h4>
<p>An utility template that generates a sha256 hash of the provided tally inputs.</p>
<p><img decoding="async" loading="lazy" alt="TallyVotesInputHasher" src="/assets/images/tallyInputHasher-59ca0a60972075ca42162a9fd5508351.svg" width="2987" height="823" class="img_aEan"></p>
<p>It outputs one field element, which is the SHA256 hash of the following inputs:</p>
<ol>
<li><code>packedVals</code></li>
<li><code>sbCommitment</code></li>
<li><code>currentTallyCommitment</code></li>
<li><code>newTallyCommitment</code></li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="resultscommitmentverifier">ResultsCommitmentVerifier<a href="#resultscommitmentverifier" class="hash-link" aria-label="Direct link to ResultsCommitmentVerifier" title="Direct link to ResultsCommitmentVerifier">​</a></h4>
<p>An utility circuit used by the main <code>tallyVotes</code> circuit to verify that the results commitment is correct.</p>
<p><img decoding="async" loading="lazy" alt="ResultsCommitmentVerifier" src="/assets/images/resultsCommitmentVerifier-5b5eb5a74b0bbcd4a0acd20cba3d3406.svg" width="4837" height="5906" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="quincheckroot">QuinCheckRoot<a href="#quincheckroot" class="hash-link" aria-label="Direct link to QuinCheckRoot" title="Direct link to QuinCheckRoot">​</a></h4>
<p>Utility circuit that given a quin Merkle root and a list of leaves, check if the root is the correct result of inserting all the leaves into the tree in the given order.</p>
<p><img decoding="async" loading="lazy" alt="QuinCheckRoot" src="/assets/images/quinCheckRoot-5d26ba2637bb3756b97cbf080f7d8bc6.svg" width="2872" height="2000" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="calculatetotal">CalculateTotal<a href="#calculatetotal" class="hash-link" aria-label="Direct link to CalculateTotal" title="Direct link to CalculateTotal">​</a></h4>
<p>Utility circuit used to calculate the sum of an array of elements.</p>
<p><img decoding="async" loading="lazy" alt="CalculateTotal" src="/assets/images/calculateTotal-1ee279f0713e6c7e319d4060e85ea7c0.svg" width="3139" height="1517" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="ecdh">ECDH<a href="#ecdh" class="hash-link" aria-label="Direct link to ECDH" title="Direct link to ECDH">​</a></h4>
<p>Utility circuit used to generate a shared key from a private key and a public key.</p>
<p><img decoding="async" loading="lazy" alt="ECDH" src="/assets/images/ecdh-557b95ff10a698ebc53ac66a6f6f36df.svg" width="3250" height="1186" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="poseidon">Poseidon<a href="#poseidon" class="hash-link" aria-label="Direct link to Poseidon" title="Direct link to Poseidon">​</a></h4>
<p>Utility circuit used to generate a Poseidon hash. In this case, it supports up to 13 inputs.</p>
<p><img decoding="async" loading="lazy" alt="Poseidon13" src="/assets/images/poseidonHasher13-960a257430e10aa50c6e3f69c60c72b9.svg" width="3935" height="1583" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="messagetocommand">MessageToCommand<a href="#messagetocommand" class="hash-link" aria-label="Direct link to MessageToCommand" title="Direct link to MessageToCommand">​</a></h4>
<p>Utility circuit used to convert a message into a command, this involves decrypting the message.</p>
<p><img decoding="async" loading="lazy" alt="MessageToCommand" src="/assets/images/messageToCommand-6344d904603bf4d10ced713417f50598.svg" width="4616" height="1901" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="messagevalidator">MessageValidator<a href="#messagevalidator" class="hash-link" aria-label="Direct link to MessageValidator" title="Direct link to MessageValidator">​</a></h4>
<p>Utility circuit used to validate a message. This performs several checks:</p>
<ul>
<li><code>stateTreeIndex</code> is valid</li>
<li><code>voteOptionIndex</code> is valid</li>
<li><code>nonce</code> is valid</li>
<li>the signature is valid</li>
<li>the user signed up before poll end timestamp</li>
<li>the user had enough voice credits</li>
</ul>
<p><img decoding="async" loading="lazy" alt="MessageValidator" src="/assets/images/messageValidator-e4a244ed1b5f7a3cd294f09e27ef1963.svg" width="5768" height="3433" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="privtopubkey">PrivToPubKey<a href="#privtopubkey" class="hash-link" aria-label="Direct link to PrivToPubKey" title="Direct link to PrivToPubKey">​</a></h4>
<p>Utility circuit used to generate a public key from a private key.</p>
<p><img decoding="async" loading="lazy" alt="PrivToPubKey" src="/assets/images/privToPubkey-de8efa15b6d7c62574b4186b267f9f4d.svg" width="2888" height="1228" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="verifysignature">VerifySignature<a href="#verifysignature" class="hash-link" aria-label="Direct link to VerifySignature" title="Direct link to VerifySignature">​</a></h4>
<p>Utility circuit used to verify a EdDSA signature</p>
<p><img decoding="async" loading="lazy" alt="VerifySignature" src="/assets/images/verifySignature-541cdc4525efbd09b59f5e7d119fcbd8.svg" width="3652" height="1491" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="unpackelement">UnpackElement<a href="#unpackelement" class="hash-link" aria-label="Direct link to UnpackElement" title="Direct link to UnpackElement">​</a></h4>
<p>Utility circuit used to unpack an input element.</p>
<p><img decoding="async" loading="lazy" alt="UnpackElement" src="/assets/images/unpackElement-968db0655e7a10eee0411a7399b448b4.svg" width="2573" height="1635" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="quinselector">QuinSelector<a href="#quinselector" class="hash-link" aria-label="Direct link to QuinSelector" title="Direct link to QuinSelector">​</a></h4>
<p>Utility circuit used to select one element from an array of n elements at a given index.</p>
<p><img decoding="async" loading="lazy" alt="QuinSelector" src="/assets/images/quinSelector-3c528a05eef484220f9d1385ac259ccd.svg" width="3452" height="1114" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="splicer">Splicer<a href="#splicer" class="hash-link" aria-label="Direct link to Splicer" title="Direct link to Splicer">​</a></h4>
<p>Utility circuit used to insert one element in an array at position <code>index</code>.</p>
<p><img decoding="async" loading="lazy" alt="Splicer" src="/assets/images/splicer-101025f93d08b7566a576de7054cbd05.svg" width="4984" height="2778" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="quinbatchleavesexists">QuinBatchLeavesExists<a href="#quinbatchleavesexists" class="hash-link" aria-label="Direct link to QuinBatchLeavesExists" title="Direct link to QuinBatchLeavesExists">​</a></h4>
<p>Utility circuit used to check if a batch of leaves exists in a quinary tree.</p>
<p><img decoding="async" loading="lazy" alt="QuinBatchLeavesExists" src="/assets/images/quinBatchLeavesExists-3d292a7935cf1afde38dbcdf4aee17eb.svg" width="4887" height="1639" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="quingeneratepathindices">QuinGeneratePathIndices<a href="#quingeneratepathindices" class="hash-link" aria-label="Direct link to QuinGeneratePathIndices" title="Direct link to QuinGeneratePathIndices">​</a></h4>
<p>Utility circuit used to generate the indices needed to traverse the tree until we find the leaf we are looking for.</p>
<p><img decoding="async" loading="lazy" alt="QuinGeneratePathIndices" src="/assets/images/quinGeneratePathIndices-0557f1872404b9931c56dede055e8a2a.svg" width="3702" height="2130" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="processtopup">ProcessTopup<a href="#processtopup" class="hash-link" aria-label="Direct link to ProcessTopup" title="Direct link to ProcessTopup">​</a></h4>
<p>Utility circuit used to process a topup message.</p>
<p><img decoding="async" loading="lazy" alt="ProcessTopup" src="/assets/images/processTopup-6bc18dfb37ce844708e117800bb1ee86.svg" width="4422" height="2549" class="img_aEan"></p>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="processone">ProcessOne<a href="#processone" class="hash-link" aria-label="Direct link to ProcessOne" title="Direct link to ProcessOne">​</a></h4>
<p>Utility circuit used to process one message.</p>
<p><img decoding="async" loading="lazy" alt="ProcessOne" src="/assets/images/processOne-243a0451adcda7dc9e27a817b861f426.svg" width="4861" height="4509" class="img_aEan"></p>
<h2 class="anchor anchorWithStickyNavbar_I2WF" id="compile-circuits">Compile circuits<a href="#compile-circuits" class="hash-link" aria-label="Direct link to Compile circuits" title="Direct link to Compile circuits">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="prerequisites">Prerequisites<a href="#prerequisites" class="hash-link" aria-label="Direct link to Prerequisites" title="Direct link to Prerequisites">​</a></h3>
<p>Before building the project, make sure you have the following dependencies installed:</p>
<ul>
<li><a href="https://docs.circom.io/downloads/downloads/" target="_blank" rel="noopener noreferrer">circom</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="building-maci-circuits">Building MACI circuits<a href="#building-maci-circuits" class="hash-link" aria-label="Direct link to Building MACI circuits" title="Direct link to Building MACI circuits">​</a></h3>
<p>To build the two main circuits of MACI, run the following commands:</p>
<div class="codeBlockContainer_fGGS theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_GhYr"><pre tabindex="0" class="prism-code language-text codeBlock_iyix thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_Zmwf"><span class="token-line" style="color:#bfc7d5"><span class="token plain">circom --r1cs --sym --wasm --output ./build circom/test/processMessages_10-2-1-2_test.circom</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">circom --r1cs --sym --wasm --output ./build circom/test/tallyVotes_10-1-2_test.circom</span><br></span></code></pre><div class="buttonGroup_uUDv"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_X4PI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_C5XV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_TwkE"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Please note that the circuit is configured with testing purpose parameters, which means it can only handle a limited amount of messages (up to 25 messages). For more information on the parameters and how to configure them, refer to <a href="/docs/circuits/#compile-circuits">this page</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="generating-zkeys">Generating zKeys<a href="#generating-zkeys" class="hash-link" aria-label="Direct link to Generating zKeys" title="Direct link to Generating zKeys">​</a></h3>
<p>Run from the root directory to save to the <code>cli/zkeys</code> folder:</p>
<div class="language-bash codeBlockContainer_fGGS theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_GhYr"><pre tabindex="0" class="prism-code language-bash codeBlock_iyix thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_Zmwf"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pnpm setup:zkeys</span><br></span></code></pre><div class="buttonGroup_uUDv"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_X4PI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_C5XV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_TwkE"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Run from the circuits folder with <code>--outPath</code> to save to a custom folder:</p>
<div class="language-bash codeBlockContainer_fGGS theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_GhYr"><pre tabindex="0" class="prism-code language-bash codeBlock_iyix thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_Zmwf"><span class="token-line" style="color:#bfc7d5"><span class="token plain">cd circuits &amp;&amp; pnpm gen-zkeys --outPath ./CUSTOM_FOLDER_NAME</span><br></span></code></pre><div class="buttonGroup_uUDv"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_X4PI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_C5XV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_TwkE"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The larger the trees, the more time this process may take. You may also need a
machine with a very large amount of memory.</p>
<blockquote>
<p>Note that you will have to modify the parameters inside the <code>./circuits/circom/circuits.json</code> file to match your use case. For example, if you want to support up to 3125 messages, the message tree depth parameter should be set to <code>5</code> (as <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>5</mn><mn>5</mn></msup><mo>=</mo><mn>3125</mn></mrow><annotation encoding="application/x-tex">5^5 = 3125</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord">5</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">3125</span></span></span></span>).</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="measure-the-circuit-sizes">Measure the circuit sizes<a href="#measure-the-circuit-sizes" class="hash-link" aria-label="Direct link to Measure the circuit sizes" title="Direct link to Measure the circuit sizes">​</a></h4>
<p>The size of a circuit is denoted by its number of constraints. The larger this
number, the more time it takes to compile it, generate its <code>.zkey</code> file, and
perform phase 2 contributions.</p>
<p>Run this command to measure a circuit:</p>
<div class="language-bash codeBlockContainer_fGGS theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_GhYr"><pre tabindex="0" class="prism-code language-bash codeBlock_iyix thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_Zmwf"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pnpm exec snarkjs r1cs info CIRCUIT_NAME.circom</span><br></span></code></pre><div class="buttonGroup_uUDv"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_X4PI" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_C5XV"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_TwkE"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_I2WF" id="download-the-ptau-file">Download the <code>.ptau</code> file<a href="#download-the-ptau-file" class="hash-link" aria-label="Direct link to download-the-ptau-file" title="Direct link to download-the-ptau-file">​</a></h4>
<p>This file should be the result of the Perpetual Powers of Tau trusted setup
contribution which <a href="https://blog.hermez.io/hermez-cryptographic-setup/" target="_blank" rel="noopener noreferrer">Hermez Network
selected</a>.</p>
<p>When running the <code>setup:zkeys</code> command, the <code>.ptau</code> file will be downloaded automatically.</p>
<h3 class="anchor anchorWithStickyNavbar_I2WF" id="generating-and-validating-zk-proofs">Generating and Validating ZK Proofs<a href="#generating-and-validating-zk-proofs" class="hash-link" aria-label="Direct link to Generating and Validating ZK Proofs" title="Direct link to Generating and Validating ZK Proofs">​</a></h3>
<p>To generate and validate ZK proofs from the artifacts produced by <code>circom</code>, you will need <a href="https://github.com/iden3/snarkjs#groth16-1" target="_blank" rel="noopener noreferrer"><code>snarkjs</code></a>.</p>
<h2 class="anchor anchorWithStickyNavbar_I2WF" id="testing">Testing<a href="#testing" class="hash-link" aria-label="Direct link to Testing" title="Direct link to Testing">​</a></h2>
<p>To test the circuits package, please use <code>pnpm run test</code>. This will run all of the tests inside the tests folder.</p>
<p>To run individual tests, you can use the following commands (for all other circuits please refer to the <code>package.json</code> scripts section):</p>
<ul>
<li><code>pnpm run test:processMessages</code> to run the tests for the <code>processMessages</code> circuit.</li>
<li><code>pnpm run test:tallyVotes</code> to run the tests for the <code>tallyVotes</code> circuit.</li>
</ul>
<p>More details on testing are provided in the <a href="/docs/testing">testing section</a> of the documentation.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/privacy-scaling-explorations/maci/edit/dev/website/versioned_docs/version-v1.x/circuits.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_A4i3" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_uNWa"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/contracts"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Smart Contracts</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/trusted-setup"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Trusted Setup</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_DN96 thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#maci-circuits" class="table-of-contents__link toc-highlight">MACI Circuits</a></li><li><a href="#background" class="table-of-contents__link toc-highlight">Background</a><ul><li><a href="#zk-snarks" class="table-of-contents__link toc-highlight">zk-SNARKs</a></li><li><a href="#circom" class="table-of-contents__link toc-highlight">Circom</a></li><li><a href="#proving-system" class="table-of-contents__link toc-highlight">Proving system</a></li></ul></li><li><a href="#how-are-the-circuits-used" class="table-of-contents__link toc-highlight">How are the circuits used?</a></li><li><a href="#how-do-the-circuits-fit-in-a-voting-round" class="table-of-contents__link toc-highlight">How do the Circuits fit in a voting round?</a></li><li><a href="#how-do-the-circuits-work" class="table-of-contents__link toc-highlight">How do the circuits work?</a><ul><li><a href="#message-processing-processmessages" class="table-of-contents__link toc-highlight">Message processing (<code>processMessages</code>)</a></li><li><a href="#tally-votes-tallyvotes" class="table-of-contents__link toc-highlight">Tally Votes (<code>tallyVotes</code>)</a></li><li><a href="#subsisdy-subsidy" class="table-of-contents__link toc-highlight">Subsisdy (<code>subsidy</code>)</a></li><li><a href="#utility-circuits" class="table-of-contents__link toc-highlight">Utility circuits</a></li></ul></li><li><a href="#compile-circuits" class="table-of-contents__link toc-highlight">Compile circuits</a><ul><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a></li><li><a href="#building-maci-circuits" class="table-of-contents__link toc-highlight">Building MACI circuits</a></li><li><a href="#generating-zkeys" class="table-of-contents__link toc-highlight">Generating zKeys</a></li><li><a href="#generating-and-validating-zk-proofs" class="table-of-contents__link toc-highlight">Generating and Validating ZK Proofs</a></li></ul></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Documentation</a></li><li class="footer__item"><a href="https://github.com/privacy-scaling-explorations/maci" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_zI7a"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.com/invite/sF5CT5rzrR" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_zI7a"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/zkMACI" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_zI7a"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 Privacy and Scaling Explorations</div></div></div></footer></div>
</body>
</html>