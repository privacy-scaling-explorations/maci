# Command-line interface

MACI provides a command-line interface that allows for effective deployment and
testing. Applications that build on top of MACI, such as
[clr.fund](https://clr.fund/), implement their own web UIs.

Note that all the example commands default to a local Ethereum testnet at
`http://localhost:8545`, and use the Ethereum private key
`0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3`. Do not
send any real funds to the address generated by this key.

For testing purposes, you can run:

```bash
# in maci/contracts
npm run hardhat
```

## Subcommands

| Role | Action | Subcommand |
|-|-|-|
| User | Generate MACI keypair | `genMaciKeypair` |
| User | Generate MACI public key | `genMaciPubkey` |
| Coordinator | Deploy VkRegistry | `deployVkRegistry` |
| Coordinator | Set verifying keys | `setVerifyingKeys` |
| Coordinator | Create MACI instance | `create `|
| Coordinator | Deploy a new poll | `deployPoll`|
| Coordinator | Deploy a new poll processor and tallyer | `deployPpt`|
| User | Sign up | `signup` |
| User | Change key / vote | `publish` |
| Coordinator | Merge state tree | `mergeSignups` |
| Coordinator | Merge message tree | `mergeMessages` |
| Coordinator | Generate message processing and vote tallying proofs | `genProofs` |
| Coordinator | Submit proofs | `proveOnChain` |
| Coordinator | Process and tally all votes without producing proofs | `processAndTallyWithoutProofs` |
| Coordinator | Roll back message processing and vote tallying in the MACI contract | `coordinatorReset` |

## Public and private key format

MACI uses private keys in the BabyJub field for operations which occur within
zk-SNARKs, such as decrypting messages or signing commands. As MACI is deployed
on Ethereum, we seek to avoid confusing BabyJub private keys with Ethereum
private keys. To that end, users should pass serialized formats of public and
private keys to this CLI. We use `maci-domainobj`'s `PrivKey.serialize` and
`PubKey.serialize` functions to do so. 

Examples of serialized public and private keys:

```
Private key: macisk.49953af3585856f539d194b46c82f4ed54ec508fb9b882940cbe68bbc57e59e
Public key:  macipk.495140c99cbc090c74363d5e3f32705a92a9e1df8e5ebe2fd6831de9c813f01f
```

### Coordinator: Deploy VkRegistry

This command deploys an instance of a VkRegistry contract. Multiple MACI
contracts can refer to the same VkRegistry as long as they are all owned (via
`Ownable.sol`) by the same account.

Example usage:

```bash
ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js deployVkRegistry
```

Example output:

```
VkRegistry: 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0
```

### Coordinator: Set verifying keys

Note that the filename of the `.zkey` files must follow this format:

```
ProcessMessages_<STATE_TREE_DEPTH>-<MSG_TREE_DEPTH>-<MSG_SUBTREE_DEPTH>-<VOTE_OPTION_TREE_DEPTH>.test.<CONTRIBUTION_NUM>.zkey
TallyVotes_<STATE_TREE_DEPTH>-<INT_STATE_TREE_DEPTH>-<VOTE_OPTION_TREE_DEPTH>>.test.<CONTRIBUTION_NUM>>.zkey
```

Example usage:

```bash
ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js setVerifyingKeys \
    -s 10 -i 1 -m 2 -v 2 -b 1 \
    -p ./zkeys/ProcessMessages_10-2-1-2.test.0.zkey \
    -t ./zkeys/TallyVotes_10-1-2.test.0.zkey \
    -k 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0                                                       
```

Example output:

```
Generating ./zkeys/ProcessMessages_10-2-1-2.test.0.zkey.vk.json, please wait...
Generating ./zkeys/TallyVotes_10-1-2.test.0.zkey.vk.json, please wait...
Transaction hash: 0x582631c36a4e21e0b65c3f9100c6343408c8683a36ded36fc02a9be07fa079e8
```

### Coordinator: Create MACI instance

Example usage:

```bash
ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js create -k 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0
```

Example output:

```
Deploying Poseidon Contracts
Deploying Poseidon
Linking Poseidon libraries
Linking Poseidon libraries
Linking Poseidon libraries
Deploying MACI
Transferring PollFactory ownership to MACI
Transferring MessageAqFactory ownership to PollFactory
Initialising MACI
PollProcessorAndTallyer: 0xAa588d3737B611baFD7bD713445b314BD453a5C8
MACI: 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a
```

### Coordinator: Deploy poll

Example usage:

```bash
ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node ./build/index.js deployPoll \
    -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    -pk macipk.495140c99cbc090c74363d5e3f32705a92a9e1df8e5ebe2fd6831de9c813f01f \
    -t 120 -g 25 -mv 25 -i 1 -m 2 -b 1 -v 2
```

Example output:

```
Deploying Verifier
Deploying PollProcessorAndTallyer
Verifier: 0xEcFcaB0A285d3380E488A39B4BB21e777f8A4EaC
Poll ID: 0
Poll contract: 0x440B7f9b667420af04e88d4dA0B9122E05cCa5A0
```

### User: sign up

Example usage:

```bash
ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node ./build/index.js signup \
    -p macipk.b8590fdba5e9cde5606dad5db384be4d253d0a2064d1e03f9600ee021a7ebe16 \
    -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a
```

Example output:

```
Transaction hash: 0xcae04f618a0b45896732632121248c312cbc68584519c1e43932b110da9078bc
State index: 0
```

### User: publish message

Example usage: 

```bash
ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js publish \
    -p macipk.b8590fdba5e9cde5606dad5db384be4d253d0a2064d1e03f9600ee021a7ebe16 \
    -sk macisk.2ae4f199bf3925a2407f7c775c9261f351ab861d8e9ecbb84622bdd3f6d41b08 \
    -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    -i 1 -v 0 -w 9 -n 1 -o 0
```

### Coordinator: merge state tree

Example usage:

```bash
ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js mergeSignups -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a -o 0
```

### Coordinator: merge message tree

Example usage:

```bash
ETH_SK=0xc87509a1c067bbde78beb793e6fa76530b6382a4c0241e5e4a9ec0a0f44dc0d3 \
ETH_PROVIDER=http://localhost:8545 \
node build/index.js mergeMessages -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a -o 0
```

### Coordinator: generate proofs

Example usage:

```bash
node build/index.js genProofs -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    -sk macisk.49953af3585856f539d194b46c82f4ed54ec508fb9b882940cbe68bbc57e59e \
    -q 0xAa588d3737B611baFD7bD713445b314BD453a5C8 \
    -o 0 \
    -t tally.json \
    -f proofs.json \
    -r ~/rapidsnark/build/prover \
    -wp ./zkeys/ProcessMessages_10-2-1-2.test \
    -wt ./zkeys/TallyVotes_10-1-2.test \
    -zp ./zkeys/ProcessMessages_10-2-1-2.test.0.zkey \
    -zt ./zkeys/TallyVotes_10-1-2.test.0.zkey
```

### Anyone: verify tally

Example usage:

```bash
```

## Demonstration

TODO

<!--

node build/index.js deployVkRegistry && \
node build/index.js setVerifyingKeys -s 10 -i 1 -m 2 -v 2 -b 1 \
    -p ./zkeys/ProcessMessages_10-2-1-2.test.0.zkey \
    -t ./zkeys/TallyVotes_10-1-2.test.0.zkey \
    -k 0x8CdaF0CD259887258Bc13a92C0a6dA92698644C0 && \
node build/index.js create && \
node ./build/index.js deployPoll -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    -pk macipk.495140c99cbc090c74363d5e3f32705a92a9e1df8e5ebe2fd6831de9c813f01f \
    -t 20 -g 25 -mv 25 -i 1 -m 2 -b 1 -v 2 && \
node ./build/index.js signup -p macipk.b8590fdba5e9cde5606dad5db384be4d253d0a2064d1e03f9600ee021a7ebe16 \
    -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a && \
node build/index.js publish -p macipk.b8590fdba5e9cde5606dad5db384be4d253d0a2064d1e03f9600ee021a7ebe16 \
    -sk macisk.2ae4f199bf3925a2407f7c775c9261f351ab861d8e9ecbb84622bdd3f6d41b08 \
    -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    -i 0 -v 0 -w 9 -n 1 -o 0 && \ 
node build/index.js timeTravel -s 30 && \
node build/index.js mergeMessages -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a -o 0 && \
node build/index.js mergeSignups -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a -o 0 && \
rm -f tally.json proofs.json && \
node build/index.js genProofs -x 0xf204a4Ef082f5c04bB89F7D5E6568B796096735a \
    -sk macisk.49953af3585856f539d194b46c82f4ed54ec508fb9b882940cbe68bbc57e59e \
    -o 0 \
    -r ~/rapidsnark/build/prover \
    -wp ./zkeys/ProcessMessages_10-2-1-2.test \
    -wt ./zkeys/TallyVotes_10-1-2.test \
    -zp ./zkeys/ProcessMessages_10-2-1-2.test.0.zkey \
    -zt ./zkeys/TallyVotes_10-1-2.test.0.zkey \
    -t tally.json \
    -f proofs.json && \
node build/index.js verify \
    -t tally.json \
    -o 0 \
    -q 0xAa588d3737B611baFD7bD713445b314BD453a5C8
-->
